name: Deploy (Azure App Service)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-appservice-main
  cancel-in-progress: true

env:
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME }}
  AZURE_WEBAPP_URL: ${{ vars.AZURE_WEBAPP_URL }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create deploy.zip (root contains backend/ + .deployment)
        shell: bash
        run: |
          set -euo pipefail
          rm -f deploy.zip
          cat > .deployment <<'EOF'
          [config]
          SCM_DO_BUILD_DURING_DEPLOYMENT = true
          project = backend
          EOF

          zip -r deploy.zip backend .deployment \
            -x "backend/__pycache__/*" \
               "backend/.pytest_cache/*" \
               "backend/**/__pycache__/*" \
               "backend/**/.pytest_cache/*"

      - name: Validate deploy.zip structure
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import sys, zipfile

          z = zipfile.ZipFile('deploy.zip')
          bad = []
          for name in z.namelist():
              if name.startswith('backend/') or name == 'backend/':
                  continue
              if name == '.deployment':
                  continue
              bad.append(name)

          if bad:
              print('ERROR: deploy.zip contains unexpected entries (allowed: backend/ and .deployment):')
              for n in bad[:50]:
                  print(' -', n)
              sys.exit(1)

          print('OK: deploy.zip contains only backend/ and .deployment')
          PY

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure App Service build + startup
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${AZURE_RESOURCE_GROUP}" || -z "${AZURE_WEBAPP_NAME}" ]]; then
            echo "Missing vars.AZURE_RESOURCE_GROUP or vars.AZURE_WEBAPP_NAME"
            exit 1
          fi

          az webapp config appsettings set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --settings \
              SCM_DO_BUILD_DURING_DEPLOYMENT=true \
              POST_BUILD_COMMAND="python -m pip install -r backend/requirements.txt"

          # Use single-quotes for assignment so $PORT is not expanded on the runner.
          # App Service will expand $PORT at runtime inside the inner double-quotes.
          STARTUP_CMD='bash -c "cd backend && gunicorn app.main:app --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 120"'
          az webapp config set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --startup-file "${STARTUP_CMD}"

          # Avoid SCM restarts racing with zip deploy
          sleep 20

      - name: Wait for ongoing deployments
        shell: bash
        run: |
          set -euo pipefail

          # Kudu may reject zip deploy with 409 if another deployment is running.
          for i in $(seq 1 240); do
            status=$(az webapp log deployment list \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --name "${AZURE_WEBAPP_NAME}" \
              --query "[0].status" -o tsv || true)

            # status 0=receiving changes, 1=building/deploying
            if [[ "${status}" != "0" && "${status}" != "1" ]]; then
              echo "No ongoing deployment detected (latest status=${status})."
              exit 0
            fi

            echo "Ongoing deployment detected (latest status=${status}). Waiting 30s..."
            sleep 30
          done

          echo "Timed out waiting for ongoing deployment to finish. Latest deployments:"
          az webapp log deployment list \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --query "[0:5].{id:id,status:status,status_text:status_text,progress:progress,start_time:start_time,end_time:end_time}" \
            -o table
          exit 1

      - name: Deploy (az webapp deploy) and wait
        shell: bash
        run: |
          set -euo pipefail

          prev_id=$(az webapp log deployment list \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --query "[0].id" -o tsv 2>/dev/null || true)
          echo "Previous deployment id: ${prev_id:-<none>}"

          # Push the artifact asynchronously; Kudu/Oryx may keep building after the command returns.
          # NOTE: --timeout is in milliseconds for `az webapp deploy`.
          set +e
          out=$(az webapp deploy \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --type zip \
            --src-path deploy.zip \
            --async true \
            --timeout 7200000 \
            --track-status false 2>&1)
          rc=$?
          set -e
          echo "$out"

          # Kudu sometimes returns 504 even though the deployment continues server-side.
          if [[ $rc -ne 0 && "$out" != *"Status Code: 504"* ]]; then
            echo "Deploy command failed (rc=$rc)."
            exit $rc
          fi

          dep_id=""
          for i in $(seq 1 120); do
            latest_id=$(az webapp log deployment list \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --name "${AZURE_WEBAPP_NAME}" \
              --query "[0].id" -o tsv 2>/dev/null || true)
            if [[ -n "${latest_id}" && "${latest_id}" != "${prev_id}" ]]; then
              dep_id="${latest_id}"
              break
            fi
            sleep 5
          done

          if [[ -z "${dep_id}" ]]; then
            echo "No new deployment id detected after initiating deployment. Latest deployments:"
            az webapp log deployment list \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --name "${AZURE_WEBAPP_NAME}" \
              --query "[0:5].{id:id,status:status,status_text:status_text,progress:progress,start_time:start_time,end_time:end_time}" \
              -o table
            exit 1
          fi

          echo "Tracking deployment id: ${dep_id}"
          for i in $(seq 1 360); do
            status=$(az webapp log deployment show \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --name "${AZURE_WEBAPP_NAME}" \
              --deployment-id "${dep_id}" \
              --query "status" -o tsv 2>/dev/null || true)
            status_text=$(az webapp log deployment show \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --name "${AZURE_WEBAPP_NAME}" \
              --deployment-id "${dep_id}" \
              --query "status_text" -o tsv 2>/dev/null || true)
            progress=$(az webapp log deployment show \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --name "${AZURE_WEBAPP_NAME}" \
              --deployment-id "${dep_id}" \
              --query "progress" -o tsv 2>/dev/null || true)

            echo "[${i}/360] status=${status:-?} status_text=${status_text:-?} progress=${progress:-?}"

            if [[ "${status}" == "4" ]]; then
              echo "Deployment completed successfully."
              exit 0
            fi
            if [[ "${status}" == "3" ]]; then
              echo "Deployment failed. Details:"
              az webapp log deployment show \
                --resource-group "${AZURE_RESOURCE_GROUP}" \
                --name "${AZURE_WEBAPP_NAME}" \
                --deployment-id "${dep_id}" -o json
              exit 1
            fi

            sleep 10
          done

          echo "Timed out waiting for deployment to complete. Details:"
          az webapp log deployment show \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --deployment-id "${dep_id}" -o json
          exit 1

      - name: Smoke test /health
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${AZURE_WEBAPP_URL}" ]]; then
            BASE_URL="${AZURE_WEBAPP_URL%/}"
          else
            BASE_URL="https://${AZURE_WEBAPP_NAME}.azurewebsites.net"
          fi

          HEALTH_URL="${BASE_URL}/health"
          echo "Checking: ${HEALTH_URL}"

          for i in $(seq 1 30); do
            if curl -fsS "${HEALTH_URL}"; then
              echo
              echo "OK"
              exit 0
            fi
            echo "Attempt ${i}/30 failed; waiting 5s..."
            sleep 5
          done

          echo "Smoke test failed after retries"
          exit 1
