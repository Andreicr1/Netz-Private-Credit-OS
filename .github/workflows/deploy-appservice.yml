name: Deploy (Azure App Service)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-appservice-main
  cancel-in-progress: true

env:
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME }}
  AZURE_WEBAPP_URL: ${{ vars.AZURE_WEBAPP_URL }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build Python dependencies (prebuilt)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          rm -rf .python_packages
          # IMPORTANT: Azure App Service Linux images can run older glibc than the GitHub runner.
          # If we build native deps (e.g., cryptography) on the runner, we can ship binaries that
          # fail at runtime with errors like: "GLIBC_2.xx not found".
          #
          # To avoid this, download and install ONLY prebuilt manylinux wheels for CPython 3.11.
          rm -rf .wheelhouse
          python -m pip download \
            --dest .wheelhouse \
            --only-binary=:all: \
            --platform manylinux2014_x86_64 \
            --python-version 311 \
            --implementation cp \
            --abi cp311 \
            -r backend/requirements.txt

          python -m pip install \
            --no-index \
            --find-links .wheelhouse \
            -r backend/requirements.txt \
            --target .python_packages/lib/site-packages

      - name: Create deploy.zip (root contains backend/ + .deployment)
        shell: bash
        run: |
          set -euo pipefail
          rm -f deploy.zip
          cat > .deployment <<'EOF'
          [config]
          project = backend
          EOF

          zip -r deploy.zip backend .python_packages .deployment \
            -x "backend/__pycache__/*" \
               "backend/.pytest_cache/*" \
               "backend/**/__pycache__/*" \
               "backend/**/.pytest_cache/*"

      - name: Validate deploy.zip structure
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import sys, zipfile

          z = zipfile.ZipFile('deploy.zip')
          bad = []
          for name in z.namelist():
              if name.startswith('backend/') or name == 'backend/':
                  continue
              if name.startswith('.python_packages/') or name == '.python_packages/':
                  continue
              if name == '.deployment':
                  continue
              bad.append(name)

          if bad:
              print('ERROR: deploy.zip contains unexpected entries (allowed: backend/, .python_packages/, and .deployment):')
              for n in bad[:50]:
                  print(' -', n)
              sys.exit(1)

          print('OK: deploy.zip contains only backend/, .python_packages/, and .deployment')
          PY

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure App Service build + startup
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${AZURE_RESOURCE_GROUP}" || -z "${AZURE_WEBAPP_NAME}" ]]; then
            echo "Missing vars.AZURE_RESOURCE_GROUP or vars.AZURE_WEBAPP_NAME"
            exit 1
          fi

          az webapp config appsettings set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --settings \
              SCM_DO_BUILD_DURING_DEPLOYMENT=false \
              WEBSITE_RUN_FROM_PACKAGE=0 \
              PYTHONPATH=/home/site/wwwroot/.python_packages/lib/site-packages

          # Use single-quotes for assignment so $PORT is not expanded on the runner.
          # App Service will expand $PORT at runtime inside the inner double-quotes.
          STARTUP_CMD='bash -c "cd /home/site/wwwroot/backend && PYTHONPATH=/home/site/wwwroot/.python_packages/lib/site-packages gunicorn app.main:app --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:\"$PORT\" --timeout 120"'
          az webapp config set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --startup-file "${STARTUP_CMD}"

          # Avoid SCM restarts racing with zip deploy
          sleep 20

      - name: Purge stale Oryx build artifacts
        shell: bash
        run: |
          set -euo pipefail

          # Previous Oryx-based deployments leave oryx-manifest.toml and output.tar.zst
          # at /home/site/wwwroot/. When the container starts, the Oryx startup script
          # detects these, extracts the OLD build to /tmp/, redirects the app path there,
          # and overwrites PYTHONPATH — causing the new zip deployment to be ignored.
          # We delete them via the Kudu VFS REST API before deploying the new zip.
          KUDU_URL="https://${AZURE_WEBAPP_NAME}.scm.azurewebsites.net"
          TOKEN=$(az account get-access-token --query accessToken -o tsv)

          for artifact in oryx-manifest.toml output.tar.zst; do
            echo "Deleting ${artifact} from wwwroot (if exists)..."
            curl -sf -X DELETE \
              -H "Authorization: Bearer ${TOKEN}" \
              -H "If-Match: *" \
              "${KUDU_URL}/api/vfs/site/wwwroot/${artifact}" \
              && echo "  deleted." \
              || echo "  not found or already gone — OK."
          done

      - name: Deploy (az webapp deploy)
        shell: bash
        run: |
          set -euo pipefail

          # Deploy synchronously with --clean to remove ALL residual files from
          # the target directory before extracting the new zip.
          # This prevents stale Oryx artifacts from hijacking the container startup.
          # NOTE: --timeout is in milliseconds for `az webapp deploy`.
          az webapp deploy \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --type zip \
            --src-path deploy.zip \
            --clean true \
            --timeout 1800000

      - name: Smoke test /health
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${AZURE_WEBAPP_URL}" ]]; then
            BASE_URL="${AZURE_WEBAPP_URL%/}"
          else
            BASE_URL="https://${AZURE_WEBAPP_NAME}.azurewebsites.net"
          fi

          HEALTH_URL="${BASE_URL}/health"
          echo "Checking: ${HEALTH_URL}"

          for i in $(seq 1 30); do
            if curl -fsS "${HEALTH_URL}"; then
              echo
              echo "OK"
              exit 0
            fi
            echo "Attempt ${i}/30 failed; waiting 5s..."
            sleep 5
          done

          echo "Smoke test failed after retries"
          exit 1
