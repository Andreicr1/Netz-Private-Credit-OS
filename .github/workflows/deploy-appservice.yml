name: Deploy (Azure App Service)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-appservice-main
  cancel-in-progress: true

env:
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME }}
  AZURE_WEBAPP_URL: ${{ vars.AZURE_WEBAPP_URL }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build Python dependencies (prebuilt)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          rm -rf .python_packages
          python -m pip install -r backend/requirements.txt --target .python_packages/lib/site-packages

      - name: Create deploy.zip (root contains backend/ + .deployment)
        shell: bash
        run: |
          set -euo pipefail
          rm -f deploy.zip
          cat > .deployment <<'EOF'
          [config]
          project = backend
          EOF

          zip -r deploy.zip backend .python_packages .deployment \
            -x "backend/__pycache__/*" \
               "backend/.pytest_cache/*" \
               "backend/**/__pycache__/*" \
               "backend/**/.pytest_cache/*"

      - name: Validate deploy.zip structure
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import sys, zipfile

          z = zipfile.ZipFile('deploy.zip')
          bad = []
          for name in z.namelist():
              if name.startswith('backend/') or name == 'backend/':
                  continue
              if name.startswith('.python_packages/') or name == '.python_packages/':
                  continue
              if name == '.deployment':
                  continue
              bad.append(name)

          if bad:
              print('ERROR: deploy.zip contains unexpected entries (allowed: backend/, .python_packages/, and .deployment):')
              for n in bad[:50]:
                  print(' -', n)
              sys.exit(1)

          print('OK: deploy.zip contains only backend/, .python_packages/, and .deployment')
          PY

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure App Service build + startup
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${AZURE_RESOURCE_GROUP}" || -z "${AZURE_WEBAPP_NAME}" ]]; then
            echo "Missing vars.AZURE_RESOURCE_GROUP or vars.AZURE_WEBAPP_NAME"
            exit 1
          fi

          az webapp config appsettings set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --settings \
              SCM_DO_BUILD_DURING_DEPLOYMENT=false \
              WEBSITE_RUN_FROM_PACKAGE=1

          # Use single-quotes for assignment so $PORT is not expanded on the runner.
          # App Service will expand $PORT at runtime inside the inner double-quotes.
          STARTUP_CMD='bash -c "cd backend && gunicorn app.main:app --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 120"'
          az webapp config set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --startup-file "${STARTUP_CMD}"

          # Avoid SCM restarts racing with zip deploy
          sleep 20

      - name: Deploy (az webapp deploy)
        shell: bash
        run: |
          set -euo pipefail

          # Deploy synchronously; rely on /health smoke test as the source of truth.
          # NOTE: --timeout is in milliseconds for `az webapp deploy`.
          az webapp deploy \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --type zip \
            --src-path deploy.zip \
            --timeout 1800000

      - name: Smoke test /health
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${AZURE_WEBAPP_URL}" ]]; then
            BASE_URL="${AZURE_WEBAPP_URL%/}"
          else
            BASE_URL="https://${AZURE_WEBAPP_NAME}.azurewebsites.net"
          fi

          HEALTH_URL="${BASE_URL}/health"
          echo "Checking: ${HEALTH_URL}"

          for i in $(seq 1 30); do
            if curl -fsS "${HEALTH_URL}"; then
              echo
              echo "OK"
              exit 0
            fi
            echo "Attempt ${i}/30 failed; waiting 5s..."
            sleep 5
          done

          echo "Smoke test failed after retries"
          exit 1
