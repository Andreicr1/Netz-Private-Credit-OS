name: Deploy (Azure App Service)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      promote:
        description: "Promote staging slot to production after validation"
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-appservice-main
  cancel-in-progress: true

env:
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP || 'Netz-International' }}
  AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME || 'netz-prod-api' }}
  AZURE_WEBAPP_URL: ${{ vars.AZURE_WEBAPP_URL || 'https://netz-prod-api.azurewebsites.net' }}
  DEPLOY_SLOT: staging
  SWA_CLIENT_ID: ${{ vars.SWA_CLIENT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build Python dependencies (prebuilt)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          rm -rf .python_packages .wheelhouse

          python -m pip download \
            --dest .wheelhouse \
            --only-binary=:all: \
            --platform manylinux2014_x86_64 \
            --python-version 311 \
            --implementation cp \
            --abi cp311 \
            -r backend/requirements.txt

          python -m pip install \
            --no-index \
            --find-links .wheelhouse \
            -r backend/requirements.txt \
            --target .python_packages/lib/site-packages

      - name: Create deploy.zip (backend/ + .python_packages/)
        shell: bash
        run: |
          set -euo pipefail
          rm -f deploy.zip

          zip -r deploy.zip backend .python_packages \
            -x "backend/__pycache__/*" \
               "backend/.pytest_cache/*" \
               "backend/**/__pycache__/*" \
               "backend/**/.pytest_cache/*" \
               "backend/tests/*"

      - name: Validate deploy.zip structure
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import sys, zipfile

          z = zipfile.ZipFile('deploy.zip')
          bad = []
          for name in z.namelist():
              if name.startswith('backend/') or name == 'backend/':
                  continue
              if name.startswith('.python_packages/') or name == '.python_packages/':
                  continue
              bad.append(name)

          if bad:
              print('ERROR: deploy.zip contains unexpected entries (allowed: backend/ and .python_packages/):')
              for n in bad[:50]:
                  print(' -', n)
              sys.exit(1)

          if 'backend/app/main.py' not in z.namelist():
              print('ERROR: deploy.zip missing backend/app/main.py')
              sys.exit(1)

          print('OK: deploy.zip contains backend/ and .python_packages/')
          PY

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID || secrets.AZUREAPPSERVICE_CLIENTID_426D9D8CF5E44278B95832DF7A8B952C }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID || secrets.AZUREAPPSERVICE_TENANTID_86103DA9D503455CBA1DD528317C4086 }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_2DB64B82AB4142F0BF1A20F53F83988A }}

      - name: Ensure staging slot exists
        shell: bash
        run: |
          set -euo pipefail

          SLOT_EXISTS=$(az webapp deployment slot list \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --query "[?name=='${DEPLOY_SLOT}'] | length(@)" -o tsv)

          if [[ "${SLOT_EXISTS}" == "0" ]]; then
            az webapp deployment slot create \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --name "${AZURE_WEBAPP_NAME}" \
              --slot "${DEPLOY_SLOT}" \
              --configuration-source "${AZURE_WEBAPP_NAME}"
          fi

      - name: Ensure App Service runtime is Python 3.11 (prod + slot)
        shell: bash
        run: |
          set -euo pipefail

          az webapp config set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --linux-fx-version "PYTHON|3.11"

          az webapp config set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --slot "${DEPLOY_SLOT}" \
            --linux-fx-version "PYTHON|3.11"

      - name: Configure appsettings + startup (prod + slot)
        shell: bash
        run: |
          set -euo pipefail

          STARTUP_CMD='cd /home/site/wwwroot/backend && gunicorn app.main:app --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 120'

          az webapp config appsettings set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --settings \
              SCM_DO_BUILD_DURING_DEPLOYMENT=false \
              WEBSITE_RUN_FROM_PACKAGE=0 \
              PYTHONPATH=/home/site/wwwroot/.python_packages/lib/site-packages

          az webapp config appsettings set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --slot "${DEPLOY_SLOT}" \
            --settings \
              SCM_DO_BUILD_DURING_DEPLOYMENT=false \
              WEBSITE_RUN_FROM_PACKAGE=0 \
              PYTHONPATH=/home/site/wwwroot/.python_packages/lib/site-packages

          az webapp config set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --startup-file "${STARTUP_CMD}"

          az webapp config set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --slot "${DEPLOY_SLOT}" \
            --startup-file "${STARTUP_CMD}"

      - name: Deploy package to staging slot (Kudu zipdeploy)
        shell: bash
        run: |
          set -euo pipefail

          SLOT_SCM_HOST="${AZURE_WEBAPP_NAME}-${DEPLOY_SLOT}.scm.azurewebsites.net"
          KUDU_URL="https://${SLOT_SCM_HOST}"
          TOKEN=$(az account get-access-token --query accessToken -o tsv)

          curl -sf -X POST \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/zip" \
            --data-binary @deploy.zip \
            "${KUDU_URL}/api/zipdeploy?isAsync=true"

          echo "Waiting 180s for slot zip deploy extraction..."
          sleep 180

      - name: Purge stale Oryx artifacts in staging slot
        shell: bash
        run: |
          set -euo pipefail

          SLOT_SCM_HOST="${AZURE_WEBAPP_NAME}-${DEPLOY_SLOT}.scm.azurewebsites.net"
          KUDU_URL="https://${SLOT_SCM_HOST}"
          TOKEN=$(az account get-access-token --query accessToken -o tsv)

          for artifact in oryx-manifest.toml output.tar.zst; do
            curl -sf -X DELETE \
              -H "Authorization: Bearer ${TOKEN}" \
              -H "If-Match: *" \
              "${KUDU_URL}/api/vfs/site/wwwroot/${artifact}" \
              || true
          done

      - name: Run Alembic migration on staging slot (Kudu command)
        shell: bash
        run: |
          set -euo pipefail

          SLOT_SCM_HOST="${AZURE_WEBAPP_NAME}-${DEPLOY_SLOT}.scm.azurewebsites.net"
          KUDU_URL="https://${SLOT_SCM_HOST}"
          TOKEN=$(az account get-access-token --query accessToken -o tsv)

          CMD='/bin/bash /home/site/wwwroot/backend/scripts/run_alembic_migration.sh'
          RESP=$(curl -sf -X POST \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            --data "$(printf '{\"command\":\"%s\",\"dir\":\"/home/site/wwwroot\"}' "${CMD}")" \
            "${KUDU_URL}/api/command")

          MIGRATION_RESP="${RESP}" python3 - <<'PY'
          import json
          import os
          import sys

          raw = os.environ.get("MIGRATION_RESP", "")
          if not raw:
              print("Missing migration response payload")
              sys.exit(1)

          data = json.loads(raw)
          output = data.get("Output", "")
          error = data.get("Error", "")
          exit_code = data.get("ExitCode")

          try:
              normalized_exit_code = int(exit_code) if exit_code is not None else 0
          except Exception:
              print(f"Unexpected ExitCode format: {exit_code}")
              sys.exit(1)

          if output:
              print(output)
          if error:
              print(error)

          if normalized_exit_code != 0:
              print(f"Alembic migration failed with ExitCode={exit_code}")
              sys.exit(1)

          if isinstance(error, str) and error.strip():
              print("Alembic migration reported stderr output; failing deployment")
              sys.exit(1)

          print("Alembic migration completed successfully")
          PY

      - name: Smoke test staging slot /health
        shell: bash
        run: |
          set -euo pipefail

          SLOT_URL="https://${AZURE_WEBAPP_NAME}-${DEPLOY_SLOT}.azurewebsites.net"
          HEALTH_URL="${SLOT_URL}/health"

          for i in $(seq 1 40); do
            HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' "${HEALTH_URL}" || echo "000")
            if [[ "${HTTP_CODE}" == "200" ]]; then
              echo "Staging slot health check passed"
              exit 0
            fi
            echo "Staging attempt ${i}/40 -> HTTP ${HTTP_CODE}"
            sleep 10
          done

          echo "Staging slot health check failed"
          exit 1

      - name: Optional authsettingsV2 config (production app)
        shell: bash
        env:
          AZURE_SUBSCRIPTION_ID_EFFECTIVE: ${{ secrets.AZURE_SUBSCRIPTION_ID || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_2DB64B82AB4142F0BF1A20F53F83988A }}
        run: |
          set -euo pipefail

          if [[ -n "${SWA_CLIENT_ID:-}" ]]; then
            az rest --method PUT \
              --url "https://management.azure.com/subscriptions/${AZURE_SUBSCRIPTION_ID_EFFECTIVE}/resourceGroups/${AZURE_RESOURCE_GROUP}/providers/Microsoft.Web/sites/${AZURE_WEBAPP_NAME}/config/authsettingsV2?api-version=2023-12-01" \
              --body "{\"properties\":{\"platform\":{\"enabled\":true,\"runtimeVersion\":\"~1\"},\"globalValidation\":{\"requireAuthentication\":false,\"unauthenticatedClientAction\":\"AllowAnonymous\"},\"identityProviders\":{\"azureStaticWebApps\":{\"enabled\":true,\"registration\":{\"clientId\":\"${SWA_CLIENT_ID}\"}}}}}"
          fi

      - name: Swap staging slot to production
        id: slot_swap
        if: ${{ github.event_name == 'push' || inputs.promote }}
        shell: bash
        run: |
          set -euo pipefail

          az webapp deployment slot swap \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --slot "${DEPLOY_SLOT}" \
            --target-slot production

      - name: Smoke test production /health
        if: ${{ github.event_name == 'push' || inputs.promote }}
        shell: bash
        run: |
          set -euo pipefail

          BASE_URL="${AZURE_WEBAPP_URL%/}"
          HEALTH_URL="${BASE_URL}/health"

          for i in $(seq 1 40); do
            HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' "${HEALTH_URL}" || echo "000")
            if [[ "${HTTP_CODE}" == "200" ]]; then
              echo "Production health check passed"
              exit 0
            fi
            echo "Production attempt ${i}/40 -> HTTP ${HTTP_CODE}"
            sleep 10
          done

          echo "Production health check failed"
          exit 1

      - name: Rollback swap if production health fails
        if: ${{ failure() && steps.slot_swap.outcome == 'success' }}
        shell: bash
        run: |
          set -euo pipefail

          az webapp deployment slot swap \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --slot "${DEPLOY_SLOT}" \
            --target-slot production

          echo "Rollback swap executed"
