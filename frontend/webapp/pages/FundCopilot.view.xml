<mvc:View
  controllerName="netz.fund.os.pages.FundCopilot"
  xmlns:mvc="sap.ui.core.mvc"
  xmlns="sap.m"
>
  <Page title="Fund Copilot" showHeader="true">
    <content>
      <VBox class="sapUiSmallMargin" width="100%">
        <MessageStrip
          text="{= ${copilot>/status} === 'scope_forbidden' ? 'You are not authorized to query outside permitted root folders.' : '' }"
          type="Error"
          showIcon="true"
          visible="{= ${copilot>/status} === 'scope_forbidden' }"
        />

        <MessageStrip
          text="{= ${copilot>/status} === 'insufficient_evidence' ? ${copilot>/answerText} : '' }"
          type="Warning"
          showIcon="true"
          visible="{= ${copilot>/status} === 'insufficient_evidence' }"
        />

        <MessageStrip
          text="{= ${copilot>/status} === 'error' ? (${copilot>/errorMessage} || 'Request failed.') : '' }"
          type="Error"
          showIcon="true"
          visible="{= ${copilot>/status} === 'error' }"
        />

        <Panel headerText="Question" expandable="false">
          <content>
            <VBox class="sapUiSmallMargin" width="100%">
              <TextArea
                value="{copilot>/questionText}"
                rows="5"
                width="100%"
                placeholder="Enter your question (evidence-first; citations are mandatory)."
              />

              <Toolbar class="sapUiTinyMarginTop">
                <ToolbarSpacer />
                <Button text="Submit" type="Emphasized" press="onSubmit" enabled="{= !!${copilot>/questionText} &amp;&amp; ${copilot>/status} !== 'loading' }" />
                <Button text="Export Evidence Pack" type="Default" press="onExportEvidencePack" enabled="{= ${copilot>/status} !== 'loading' }" />
              </Toolbar>
            </VBox>
          </content>
        </Panel>

        <Panel headerText="Answer" expandable="false" class="sapUiTinyMarginTop" visible="{= ${copilot>/hasAnswer} }">
          <content>
            <VBox class="sapUiSmallMargin" width="100%">
              <TextArea value="{copilot>/answerText}" rows="10" width="100%" editable="false" growing="true" />
            </VBox>
          </content>
        </Panel>

        <Panel headerText="Citations" expandable="false" class="sapUiTinyMarginTop" visible="{= ${copilot>/hasCitations} }">
          <content>
            <List items="{copilot>/citations}" growing="true" growingScrollToLoad="true">
              <CustomListItem>
                <VBox class="sapUiSmallMargin" width="100%">
                  <Text text="{= 'Root folder: ' + (${copilot>root_folder} || '') }" />
                  <Text text="{= 'Document: ' + (${copilot>document_title} || '') }" />
                  <Text text="{= 'Version: ' + (${copilot>version_number} || '') }" />
                  <Text text="{= 'Pages: ' + ((${copilot>page_start} || '') + '-' + (${copilot>page_end} || '')) }" />
                  <Link text="{copilot>source_blob}" href="{copilot>source_blob}" target="_blank" />
                </VBox>
              </CustomListItem>
            </List>
          </content>
        </Panel>

        <Panel headerText="Conversation History" expandable="false" class="sapUiTinyMarginTop" visible="{copilot>/historyVisible}">
          <content>
            <VBox class="sapUiSmallMargin" width="100%">
              <MessageStrip
                text="{copilot>/historyMessage}"
                type="Information"
                showIcon="true"
                visible="{= !!${copilot>/historyMessage} }"
              />
              <List items="{copilot>/history}" growing="true" visible="{= ${copilot>/history}.length > 0 }">
                <CustomListItem>
                  <VBox class="sapUiSmallMargin" width="100%">
                    <Text text="{copilot>created_at_utc}" />
                    <Text text="{= 'Q: ' + (${copilot>question_text} || '') }" wrapping="true" />
                    <Text text="{= 'A: ' + (${copilot>answer_text} || '') }" wrapping="true" />
                  </VBox>
                </CustomListItem>
              </List>
            </VBox>
          </content>
        </Panel>
      </VBox>
    </content>
  </Page>
</mvc:View>
