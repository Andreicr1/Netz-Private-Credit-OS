<mvc:View
  controllerName="netz.fund.os.pages.ObligationDetail"
  xmlns:mvc="sap.ui.core.mvc"
  xmlns="sap.m"
  xmlns:f="sap.ui.layout.form"
>
  <Page title="Obligation" showNavButton="true" navButtonPress="onNavBack">
    <content>
      <VBox class="sapUiSmallMargin" width="100%">
        <MessageStrip
          text="{= ${obligation>/status} === 'error' ? (${obligation>/errorMessage} || 'Failed to load obligation.') : '' }"
          type="Error"
          showIcon="true"
          visible="{= ${obligation>/status} === 'error' }"
        />

        <f:SimpleForm editable="false" layout="ResponsiveGridLayout" title="Details">
          <f:content>
            <Label text="Name" />
            <Text text="{obligation>/item/name}" />

            <Label text="Regulator" />
            <Text text="{obligation>/item/regulator}" />

            <Label text="Workflow" />
            <ObjectStatus text="{obligation>/item/workflow_status}" state="{= ${obligation>/item/workflow_status} === 'CLOSED' ? 'Success' : (${obligation>/item/workflow_status} === 'IN_PROGRESS' ? 'Warning' : 'None') }" />

            <Label text="Active" />
            <Text text="{= ${obligation>/item/is_active} ? 'Yes' : 'No' }" />

            <Label text="Description" />
            <Text text="{obligation>/item/description}" wrapping="true" />

            <Label text="Created" />
            <Text text="{obligation>/item/created_at}" />

            <Label text="Updated" />
            <Text text="{obligation>/item/updated_at}" />
          </f:content>
        </f:SimpleForm>

        <Toolbar class="sapUiTinyMarginTop">
          <Title text="Workflow" level="H3" />
          <ToolbarSpacer />
          <Button text="Mark In Progress" type="Default" enabled="{obligation>/canWrite}" press="onMarkInProgress" />
          <Button text="Close (Requires Evidence)" type="Emphasized" enabled="{obligation>/canWrite}" press="onClose" />
        </Toolbar>

        <Toolbar class="sapUiTinyMarginTop">
          <Title text="Evidence (Link Data Room Document)" level="H3" />
          <ToolbarSpacer />
          <Button text="Refresh" type="Transparent" press="onRefreshEvidence" />
        </Toolbar>

        <HBox width="100%" class="sapUiTinyMarginTop">
          <Select
            width="100%"
            items="{obligation>/documents}"
            selectedKey="{obligation>/selectedDocumentId}"
          >
            <core:Item key="{obligation>id}" text="{= (${obligation>root_folder} || '') + ' / ' + (${obligation>folder_path} || '') + ' â€” ' + (${obligation>title} || '') }" xmlns:core="sap.ui.core" />
          </Select>
          <Button text="Link" type="Emphasized" enabled="{= ${obligation>/canWrite} &amp;&amp; !!${obligation>/selectedDocumentId} }" press="onLinkEvidence" class="sapUiTinyMarginBegin" />
        </HBox>

        <Table id="evidenceTable" items="{obligation>/evidence}" inset="false" width="100%" class="sapUiTinyMarginTop">
          <columns>
            <Column><Text text="Root Folder" /></Column>
            <Column><Text text="Folder Path" /></Column>
            <Column><Text text="Title" /></Column>
            <Column><Text text="Linked At" /></Column>
            <Column><Text text="Linked By" /></Column>
          </columns>
          <items>
            <ColumnListItem>
              <cells>
                <Text text="{obligation>root_folder}" />
                <Text text="{obligation>folder_path}" />
                <Text text="{obligation>title}" />
                <Text text="{obligation>linked_at}" />
                <Text text="{obligation>linked_by}" />
              </cells>
            </ColumnListItem>
          </items>
        </Table>

        <Toolbar class="sapUiTinyMarginTop">
          <Title text="Audit Trail" level="H3" />
          <ToolbarSpacer />
          <Button text="Refresh" type="Transparent" press="onRefreshAudit" />
        </Toolbar>

        <Table id="auditTable" items="{obligation>/audit}" inset="false" width="100%" class="sapUiTinyMarginTop">
          <columns>
            <Column><Text text="At" /></Column>
            <Column><Text text="Actor" /></Column>
            <Column><Text text="Action" /></Column>
            <Column><Text text="After" /></Column>
          </columns>
          <items>
            <ColumnListItem>
              <cells>
                <Text text="{obligation>created_at}" />
                <Text text="{obligation>actor_id}" />
                <Text text="{obligation>action}" />
                <Text text="{obligation>after}" wrapping="true" />
              </cells>
            </ColumnListItem>
          </items>
        </Table>
      </VBox>
    </content>
  </Page>
</mvc:View>
