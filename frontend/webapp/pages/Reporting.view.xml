<mvc:View
  controllerName="netz.fund.os.pages.Reporting"
  xmlns:mvc="sap.ui.core.mvc"
  xmlns="sap.m"
  xmlns:core="sap.ui.core"
  xmlns:form="sap.ui.layout.form"
>
  <Page title="Reporting" showHeader="true">
    <content>
      <VBox class="sapUiSmallMargin" width="100%">
        <MessageStrip
          text="{reporting>/errorMessage}"
          type="Error"
          showIcon="true"
          visible="{= !!${reporting>/errorMessage} }"
        />

        <Panel headerText="Export Controls" expandable="false">
          <content>
            <Toolbar class="sapUiSmallMargin">
              <ToolbarSpacer />
              <Button text="Export JSON" type="Emphasized" press="onExportAllJson" />
              <Button text="Export CSV" type="Default" press="onExportAllCsv" />
            </Toolbar>
          </content>
        </Panel>

        <Panel headerText="Evidence Packs" expandable="false" class="sapUiTinyMarginTop">
          <content>
            <Toolbar class="sapUiSmallMargin">
              <Text text="Latest AI answers with citations." />
              <ToolbarSpacer />
              <Button text="Refresh" press="onRefreshEvidencePacks" enabled="{= ${reporting>/busy} !== true }" />
              <Button text="Export JSON" press="onExportEvidencePacksJson" enabled="{= ${reporting>/evidencePacks}.length > 0 }" />
              <Button text="Export CSV" press="onExportEvidencePacksCsv" enabled="{= ${reporting>/evidencePacks}.length > 0 }" />
            </Toolbar>

            <Table items="{reporting>/evidencePacks}" inset="false" growing="true">
              <columns>
                <Column width="55%"><Text text="Question" /></Column>
                <Column width="20%"><Text text="Date" /></Column>
                <Column width="15%"><Text text="Citations" /></Column>
                <Column width="10%"><Text text="Export" /></Column>
              </columns>
              <items>
                <ColumnListItem>
                  <cells>
                    <Text text="{reporting>question}" wrapping="true" />
                    <Text text="{reporting>created_at_utc}" />
                    <Text text="{reporting>citations_count}" />
                    <Button text="Export" type="Transparent" press="onExportEvidencePackItem" />
                  </cells>
                </ColumnListItem>
              </items>
            </Table>
          </content>
        </Panel>

        <Panel headerText="Compliance Status" expandable="false" class="sapUiTinyMarginTop">
          <content>
            <Toolbar class="sapUiSmallMargin">
              <Text text="Read-only snapshot." />
              <ToolbarSpacer />
              <Button text="Refresh" press="onRefreshCompliance" enabled="{= ${reporting>/busy} !== true }" />
              <Button text="Export JSON" press="onExportComplianceJson" enabled="{= !!${reporting>/complianceSnapshot/generated_at_utc} }" />
            </Toolbar>

            <form:SimpleForm editable="false" layout="ResponsiveGridLayout" class="sapUiSmallMargin">
              <Label text="Total open obligations" />
              <Text text="{reporting>/complianceSnapshot/total_open_obligations}" />
              <Label text="Total AI gaps" />
              <Text text="{reporting>/complianceSnapshot/total_ai_gaps}" />
              <Label text="Closed obligations (last 30 days)" />
              <Text text="{reporting>/complianceSnapshot/closed_obligations_last_30_days}" />
              <Label text="Generated at (UTC)" />
              <Text text="{reporting>/complianceSnapshot/generated_at_utc}" />
            </form:SimpleForm>
          </content>
        </Panel>

        <Panel headerText="Cash Ledger Summary" expandable="false" class="sapUiTinyMarginTop">
          <content>
            <Toolbar class="sapUiSmallMargin">
              <Text text="USD snapshot (server-side totals)." />
              <ToolbarSpacer />
              <Button text="Refresh" press="onRefreshCash" enabled="{= ${reporting>/busy} !== true }" />
              <Button text="Export JSON" press="onExportCashJson" enabled="{= !!${reporting>/cashSnapshot/generated_at_utc} }" />
            </Toolbar>

            <form:SimpleForm editable="false" layout="ResponsiveGridLayout" class="sapUiSmallMargin">
              <Label text="Total Inflows (USD)" />
              <Text text="{reporting>/cashSnapshot/total_inflows_usd}" />
              <Label text="Total Outflows (USD)" />
              <Text text="{reporting>/cashSnapshot/total_outflows_usd}" />
              <Label text="Pending Payment Orders" />
              <Text text="{reporting>/cashSnapshot/pending_payment_orders}" />
              <Label text="Last Reconciliation Date" />
              <Text text="{reporting>/cashSnapshot/last_reconciliation_date}" />
              <Label text="Generated at (UTC)" />
              <Text text="{reporting>/cashSnapshot/generated_at_utc}" />
            </form:SimpleForm>
          </content>
        </Panel>

        <Panel headerText="AI Activity Log" expandable="false" class="sapUiTinyMarginTop">
          <content>
            <Toolbar class="sapUiSmallMargin">
              <Text text="Read-only activity (answers)." />
              <ToolbarSpacer />
              <Button text="Refresh" press="onRefreshAIActivity" enabled="{= ${reporting>/busy} !== true }" />
              <Button text="Export JSON" press="onExportAIActivityJson" enabled="{= ${reporting>/aiActivity}.length > 0 }" />
              <Button text="Export CSV" press="onExportAIActivityCsv" enabled="{= ${reporting>/aiActivity}.length > 0 }" />
            </Toolbar>

            <Table items="{reporting>/aiActivity}" inset="false" growing="true">
              <columns>
                <Column width="55%"><Text text="Question" /></Column>
                <Column width="15%"><Text text="Asked by" /></Column>
                <Column width="20%"><Text text="Timestamp" /></Column>
                <Column width="10%"><Text text="Insufficient" /></Column>
              </columns>
              <items>
                <ColumnListItem>
                  <cells>
                    <Text text="{reporting>question}" wrapping="true" />
                    <Text text="{reporting>asked_by}" />
                    <Text text="{reporting>timestamp_utc}" />
                    <Text text="{= ${reporting>insufficient_evidence} ? 'Yes' : 'No' }" />
                  </cells>
                </ColumnListItem>
              </items>
            </Table>
          </content>
        </Panel>
      </VBox>
    </content>
  </Page>
</mvc:View>
