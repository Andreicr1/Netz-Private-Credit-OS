<mvc:View
  controllerName="netz.fund.os.modules.reporting.Reporting"
  xmlns:mvc="sap.ui.core.mvc"
  xmlns="sap.m"
  xmlns:core="sap.ui.core"
  xmlns:form="sap.ui.layout.form"
>
  <Page title="Reporting Archive" showHeader="true">
    <content>
      <VBox class="sapUiSmallMargin" width="100%">
        <MessageStrip
          text="{reports>/errorMessage}"
          type="Error"
          showIcon="true"
          visible="{= !!${reports>/errorMessage} }"
        />

        <Toolbar class="sapUiSmallMarginBottom">
          <Text text="Fund" />
          <Text text="{reports>/fundId}" />
          <ToolbarSpacer />
          <Button text="Refresh" type="Emphasized" press="onRefresh" enabled="{= ${reports>/busy} !== true }" />
        </Toolbar>

        <Panel headerText="Operations" expandable="true" expanded="true" class="sapUiTinyMarginBottom">
          <content>
            <VBox class="sapUiSmallMargin">
              <HBox justifyContent="SpaceBetween" alignItems="Center">
                <VBox>
                  <Title text="Write Actions" level="H4" />
                  <Text text="Buttons are enabled only when the backend roles allow. All lifecycle enforcement remains server-side." wrapping="true" />
                </VBox>
                <ObjectStatus text="{= ${view>/canWrite} ? 'WRITE ENABLED' : 'READ ONLY'}" state="{= ${view>/canWrite} ? 'Success' : 'None'}" />
              </HBox>

              <Panel headerText="Create NAV Snapshot" expandable="true" expanded="true">
                <content>
                  <form:SimpleForm editable="true" layout="ResponsiveGridLayout">
                    <form:content>
                      <Label text="Period (YYYY-MM)" />
                      <Input value="{op>/newSnapshot/period_month}" placeholder="2025-01" width="14rem" />

                      <Label text="NAV Total (USD)" />
                      <Input value="{op>/newSnapshot/nav_total_usd}" type="Number" width="14rem" />

                      <Label text="" />
                      <Button text="Create Snapshot" type="Emphasized" enabled="{view>/canWrite}" press="onCreateSnapshot" />
                    </form:content>
                  </form:SimpleForm>
                </content>
              </Panel>

              <Panel headerText="NAV Snapshots" expandable="true" expanded="true">
                <content>
                  <Table items="{data>/navSnapshots}" mode="SingleSelectMaster" selectionChange="onSelectSnapshot">
                    <headerToolbar>
                      <Toolbar>
                        <Title text="Snapshots" level="H4" />
                        <ToolbarSpacer />
                        <Button text="Refresh" press="onRefreshAll" />
                      </Toolbar>
                    </headerToolbar>
                    <columns>
                      <Column><Text text="ID" /></Column>
                      <Column><Text text="Period" /></Column>
                      <Column><Text text="Status" /></Column>
                      <Column hAlign="End"><Text text="NAV (USD)" /></Column>
                      <Column><Text text="Actions" /></Column>
                    </columns>
                    <items>
                      <ColumnListItem>
                        <cells>
                          <Text text="{data>id}" />
                          <Text text="{data>period_month}" />
                          <ObjectStatus text="{data>status}" />
                          <Text text="{data>nav_total_usd}" />
                          <HBox>
                            <Button text="Finalize" enabled="{= ${view>/canWrite} &amp;&amp; ${data>status} === 'DRAFT'}" press="onFinalizeSnapshot" />
                            <Button text="Publish" enabled="{= ${view>/canWrite} &amp;&amp; ${data>status} === 'FINALIZED'}" press="onPublishSnapshot" />
                          </HBox>
                        </cells>
                      </ColumnListItem>
                    </items>
                  </Table>
                </content>
              </Panel>

              <Panel headerText="Record Asset Valuation" expandable="true" expanded="true">
                <content>
                  <form:SimpleForm editable="true" layout="ResponsiveGridLayout">
                    <form:content>
                      <Label text="Snapshot" />
                      <Input value="{op>/newValuation/nav_snapshot_id}" placeholder="Select a snapshot above" width="18rem" editable="false" />

                      <Label text="Asset ID" />
                      <Input value="{op>/newValuation/asset_id}" width="18rem" />

                      <Label text="Asset Type" />
                      <Input value="{op>/newValuation/asset_type}" placeholder="e.g. LOAN" width="18rem" />

                      <Label text="Valuation (USD)" />
                      <Input value="{op>/newValuation/valuation_usd}" type="Number" width="18rem" />

                      <Label text="Method" />
                      <Select selectedKey="{op>/newValuation/valuation_method}" width="18rem">
                        <core:Item key="AMORTIZED_COST" text="AMORTIZED_COST" />
                        <core:Item key="FAIR_VALUE" text="FAIR_VALUE" />
                        <core:Item key="MARK_TO_MARKET" text="MARK_TO_MARKET" />
                      </Select>

                      <Label text="Supporting Document ID (required for non-amortized)" />
                      <Input value="{op>/newValuation/supporting_document_id}" width="18rem" />

                      <Label text="" />
                      <Button text="Record Valuation" type="Emphasized" enabled="{= ${view>/canWrite} &amp;&amp; !!${op>/newValuation/nav_snapshot_id} }" press="onRecordValuation" />
                    </form:content>
                  </form:SimpleForm>

                  <Table items="{data>/selectedSnapshot/assets}" growing="true" growingScrollToLoad="true">
                    <headerToolbar>
                      <Toolbar>
                        <Title text="Selected Snapshot Assets" level="H4" />
                      </Toolbar>
                    </headerToolbar>
                    <columns>
                      <Column><Text text="Asset ID" /></Column>
                      <Column><Text text="Type" /></Column>
                      <Column><Text text="Method" /></Column>
                      <Column hAlign="End"><Text text="Valuation (USD)" /></Column>
                      <Column><Text text="Supporting Doc" /></Column>
                    </columns>
                    <items>
                      <ColumnListItem>
                        <cells>
                          <Text text="{data>asset_id}" />
                          <Text text="{data>asset_type}" />
                          <Text text="{data>valuation_method}" />
                          <Text text="{data>valuation_usd}" />
                          <Text text="{data>supporting_document_id}" />
                        </cells>
                      </ColumnListItem>
                    </items>
                  </Table>
                </content>
              </Panel>

              <Panel headerText="Generate Monthly Pack" expandable="true" expanded="true">
                <content>
                  <form:SimpleForm editable="true" layout="ResponsiveGridLayout">
                    <form:content>
                      <Label text="Snapshot ID" />
                      <Input value="{op>/pack/nav_snapshot_id}" width="18rem" />

                      <Label text="Pack Type" />
                      <Select selectedKey="{op>/pack/pack_type}" width="18rem">
                        <core:Item key="MONTHLY" text="MONTHLY" />
                        <core:Item key="QUARTERLY" text="QUARTERLY" />
                      </Select>

                      <Label text="Include Evidence Binder" />
                      <Switch state="{op>/pack/include_evidence_binder}" />

                      <Label text="Binder Limit" />
                      <Input value="{op>/pack/evidence_binder_limit}" type="Number" width="18rem" />

                      <Label text="" />
                      <Button text="Generate Pack" type="Emphasized" enabled="{view>/canWrite}" press="onGeneratePack" />
                    </form:content>
                  </form:SimpleForm>
                </content>
              </Panel>

              <Panel headerText="Generate Investor Statement" expandable="true" expanded="true">
                <content>
                  <form:SimpleForm editable="true" layout="ResponsiveGridLayout">
                    <form:content>
                      <Label text="Period (YYYY-MM)" />
                      <Input value="{op>/statement/period_month}" placeholder="2025-01" width="18rem" />

                      <Label text="Investor ID" />
                      <Input value="{op>/statement/investor_id}" width="18rem" />

                      <Label text="Ending Balance" />
                      <Input value="{op>/statement/ending_balance}" type="Number" width="18rem" />

                      <Label text="" />
                      <Button text="Generate Statement" type="Emphasized" enabled="{view>/canWrite}" press="onGenerateStatement" />
                    </form:content>
                  </form:SimpleForm>
                </content>
              </Panel>
            </VBox>
          </content>
        </Panel>

        <Panel headerText="Published NAV Snapshots" expandable="false">
          <content>
            <Table items="{reports>/nav_snapshots}" inset="false" growing="true">
              <columns>
                <Column width="15%"><Text text="Period" /></Column>
                <Column width="20%"><Text text="NAV (USD)" /></Column>
                <Column width="25%"><Text text="Published At" /></Column>
                <Column width="20%"><Text text="Status" /></Column>
              </columns>
              <items>
                <ColumnListItem>
                  <cells>
                    <Text text="{reports>period_month}" />
                    <Text text="{reports>nav_total_usd}" />
                    <Text text="{reports>published_at}" />
                    <Text text="{reports>status}" />
                  </cells>
                </ColumnListItem>
              </items>
            </Table>
          </content>
        </Panel>

        <Panel headerText="Monthly Packs" expandable="false" class="sapUiTinyMarginTop">
          <content>
            <Table items="{reports>/monthly_packs}" inset="false" growing="true">
              <columns>
                <Column width="18%"><Text text="Pack Type" /></Column>
                <Column width="18%"><Text text="Generated At" /></Column>
                <Column width="24%"><Text text="Published At" /></Column>
                <Column width="25%"><Text text="Blob" /></Column>
                <Column width="15%"><Text text="Download" /></Column>
              </columns>
              <items>
                <ColumnListItem>
                  <cells>
                    <Text text="{reports>pack_type}" />
                    <Text text="{reports>generated_at}" />
                    <Text text="{reports>published_at}" />
                    <Text text="{reports>blob_path}" wrapping="true" />
                    <Button text="Download" type="Transparent" press="onDownloadMonthlyPack" />
                  </cells>
                </ColumnListItem>
              </items>
            </Table>
          </content>
        </Panel>

        <Panel headerText="Investor Statements" expandable="false" class="sapUiTinyMarginTop">
          <content>
            <Table items="{reports>/investor_statements}" inset="false" growing="true">
              <columns>
                <Column width="15%"><Text text="Period" /></Column>
                <Column width="25%"><Text text="Investor" /></Column>
                <Column width="30%"><Text text="Created At" /></Column>
                <Column width="15%"><Text text="Download" /></Column>
              </columns>
              <items>
                <ColumnListItem>
                  <cells>
                    <Text text="{reports>period_month}" />
                    <Text text="{reports>investor_id}" />
                    <Text text="{reports>created_at}" />
                    <Button text="Download" type="Transparent" press="onDownloadInvestorStatement" />
                  </cells>
                </ColumnListItem>
              </items>
            </Table>
          </content>
        </Panel>
      </VBox>
    </content>
  </Page>
</mvc:View>
